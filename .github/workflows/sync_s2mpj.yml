name: Sync S2MPJ Python Subset

on:
  push:
  schedule:
    # Run once a day at 00:00 UTC to check for updates
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allows manual triggering of the workflow from the GitHub Actions tab

permissions:
  contents: write

jobs:
  sync-and-filter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Local Repository
        uses: actions/checkout@v4

      - name: Configure Git Identity
        # Set up the git user to be the GitHub Actions bot for commits
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Sync and Filter Files
        run: |
          # 1. Attempt to clone the upstream repository
          # We check the exit code to ensure the clone was successful before proceeding.
          echo "Cloning upstream repository..."
          if ! git clone --depth 1 https://github.com/GrattonToint/S2MPJ.git temp_upstream; then
            echo "::error::Failed to fetch upstream repository. Aborting sync to prevent data loss."
            exit 1
          fi

          echo "Upstream cloned successfully. Syncing files..."

          # 2. Clean managed files in current workspace for fresh sync
          # Only remove the specific files/folders we are syncing.
          mkdir -p src
          rm -rf src/python_problems src/list_of_python_problems src/s2mpjlib.py

          # 3. Copy only the specific files/folders we want from the temporary upstream directory
          echo "Copying selected files..."
          
          # Copy the 'python_problems' directory
          if [ -d "temp_upstream/python_problems" ]; then
            cp -r temp_upstream/python_problems src/
          else
            echo "::warning::Dir 'python_problems' not found in upstream"
          fi
          
          # Copy the 'list_of_python_problems' file
          if [ -f "temp_upstream/list_of_python_problems" ]; then
            cp temp_upstream/list_of_python_problems src/
          else 
            echo "::warning::File 'list_of_python_problems' not found in upstream"
          fi

          # Copy the 's2mpjlib.py' file
          if [ -f "temp_upstream/s2mpjlib.py" ]; then
            cp temp_upstream/s2mpjlib.py src/
          else
             echo "::warning::File 's2mpjlib.py' not found in upstream"
          fi

          # 4. Remove the temporary upstream directory
          rm -rf temp_upstream

          # 5. Commit and push the changes
          git add src
          
          # Check if there are any changes staged for commit
          if git diff --staged --quiet; then
            echo "No changes detected. The 'src' folder is up to date."
          else
            echo "Updates detected. Committing changes..."
            git commit -m "Auto-sync subset files from GrattonToint/S2MPJ"
            git push
          fi
